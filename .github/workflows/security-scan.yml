name: Security Checks

on:
  push:
    branches: [ main, develop, 'fix/**', 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: Security Scan with Bandit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install --upgrade pip
        pip install bandit[toml] pytest pytest-cov
        pip install -r requirements.txt
    
    - name: Run Bandit Security Scan
      run: |
        cd backend
        bandit -r app/ -f json -o bandit-report.json || true
        bandit -r app/ -ll -i
      continue-on-error: false
    
    - name: Run Security Tests
      run: |
        cd backend
        pytest tests/test_security_utils.py -v --tb=short
      env:
        PYTHONPATH: .
        APP_MODE: test
        DATABASE_URL: sqlite:///./test.db
        JWT_SECRET: test-secret-for-ci-minimum-32-chars
    
    - name: Upload Bandit Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: bandit-security-report
        path: backend/bandit-report.json
        retention-days: 30
  
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: python
        queries: security-and-quality
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:python"
